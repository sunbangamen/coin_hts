# Issue #19 해결 계획: 데이터 관리 페이지 구현

## 1. 이슈 정보 요약

**이슈 번호**: #19
**제목**: 데이터 관리 페이지 구현 (OHLCV 데이터 업로드 및 조회)
**상태**: OPEN
**생성일**: 2025-11-06
**라벨**: `enhancement`, `backend`, `frontend`, `data-management`, `Phase 5`

### 핵심 요구사항
웹 UI를 통해 OHLCV 데이터 파일(.parquet)을 조회하고 업로드할 수 있는 데이터 관리 페이지를 구현합니다. 현재는 로컬 파일 시스템에 수동으로 데이터를 배치해야 하지만, 이 기능을 통해 웹에서 직접 데이터를 관리할 수 있게 됩니다.

### 주요 제약사항
- 데이터 구조: `DATA_ROOT/{symbol}/{timeframe}/{year}.parquet`
- 심볼/타임프레임은 대문자 정규화 필요
- 절대 경로 비노출 원칙 (응답에서는 상대 경로만)
- 파일 크기 제한: 200MB
- 업로드 입력 검증: `symbol`, `timeframe`은 `[A-Z0-9]+` 패턴만 허용하고 `year`는 4자리 숫자만 허용하며, 저장 전 `os.path.normpath`를 이용해 경로가 `DATA_ROOT`를 벗어나지 않도록 강제
- 예상 작업 시간: 12~17시간

---

## 2. 현재 상태

### 기존 코드 분석
- **데이터 로더**: `backend/app/data_loader.py` - 로컬 parquet 파일 로드 로직 완성
- **백엔드 구조**: `backend/app/main.py` - 기존 모든 API 엔드포인트 한 파일에 통합
- **프론트엔드 구조**: `frontend/src/App.jsx` - React Router 미적용, 단일 페이지 구조
- **라우터 디렉토리**: 백엔드에 별도 라우터 디렉토리 없음 (모노리식 구조)

### 개선 필요 사항
- 백엔드: 데이터 API를 별도 라우터로 분리 필요
- 프론트엔드: React Router 도입 및 라우팅 구조 설정

---

## 3. 해결 계획

### 📋 작업 구조

```
Phase 5: 데이터 관리 페이지 구현
├── Task 3.1: 백엔드 데이터 인벤토리 API 구현
├── Task 3.2: 백엔드 데이터 업로드 API 구현
├── Task 3.3: 프론트엔드 데이터 관리 페이지 UI 구현
├── Task 3.4: 파일 구조 및 처리 규칙 문서화
└── Task 3.5: 통합 테스트 및 E2E 시나리오 검증
```

---

### 단계별 실행 계획

#### **Step 1: 백엔드 API 라우터 구조 설정 (30분)**
**목표**: 데이터 관리 API를 별도 라우터로 분리하여 관리성 향상

**작업 내용**:
- `backend/app/routers/data.py` 파일 생성
- `GET /api/data/inventory` 엔드포인트 기본 스켈레톤 구현
- `POST /api/data/upload` 엔드포인트 기본 스켈레톤 구현
- `backend/app/main.py`에 라우터 연결

**의존성**: 없음
**산출물**: `backend/app/routers/data.py`, 수정된 `main.py`
**확인 방법**: 서버 시작 후 `/api/data/inventory`, `/api/data/upload` 엔드포인트 존재 확인

---

#### **Step 2: 데이터 인벤토리 API 구현 (Task 3.1, 2~3시간)**
**목표**: 로컬 파일 시스템의 데이터 파일 목록을 조회하는 API 구현

**작업 내용**:
1. **헬퍼 함수 `build_inventory()` 구현**:
   - `DATA_ROOT` 디렉토리 스캔
   - 파일 경로에서 `symbol`, `timeframe`, `year` 추출
   - 파일 메타데이터 수집 (크기, 수정일)
   - 절대 경로를 상대 경로로 변환

2. **필터링 및 페이지네이션 지원**:
   - `symbol`, `timeframe`, `year` 필터링 구현
   - `limit`, `offset` 파라미터 처리
   - 최근 수정일 내림차순 정렬

3. **Pydantic 응답 스키마 정의**:
   ```python
   class DataFileInfo(BaseModel):
       symbol: str
       timeframe: str
       year: int
       relative_path: str
       size_bytes: int
       modified_at: str

   class InventoryResponse(BaseModel):
       files: List[DataFileInfo]
       total_count: int
       limit: int
       offset: int
   ```

4. **유닛 테스트 작성** (`tests/test_data_api.py`):
   - 빈 디렉토리 조회
   - 필터링 테스트
   - 페이지네이션 테스트

**의존성**: Step 1
**산출물**: `build_inventory()` 함수, 완전한 `/api/data/inventory` 엔드포인트, 유닛 테스트
**확인 방법**: `pytest tests/test_data_api.py::test_inventory_*` 통과

---

#### **Step 3: 데이터 업로드 API 구현 (Task 3.2, 3~4시간)**
**목표**: 파일 업로드 및 검증 로직 구현

**작업 내용**:
1. **파일 검증 로직 구현** (`_validate_parquet_file()`):
   - 파일 확장자 `.parquet` 검증
   - 전체 데이터를 읽지 않고 Parquet 메타데이터(`pyarrow.ParquetFile.read_schema()` 등)로 유효성 검증
   - 필수 컬럼 존재 확인: `open`, `high`, `low`, `close`, `volume`, `timestamp`
   - 파일 크기 제한 (200MB)

2. **파일 저장 로직 구현** (`save_uploaded_file()`):
   - 심볼/타임프레임 대문자 정규화
   - 목표 경로 생성: `DATA_ROOT/{SYMBOL}/{TIMEFRAME}/{year}.parquet`
   - 입력값을 화이트리스트 정규식으로 검증하고 `os.path.normpath` 및 루트 경로 비교로 디렉토리 이탈 방지
   - 임시 파일에 저장 후 원자적 이동 (`os.replace`)
   - 덮어쓰기 방지 (기본 409 Conflict, `overwrite=true` 옵션 지원)

3. **엔드포인트 구현**:
   - `POST /api/data/upload` (multipart/form-data)
   - 파라미터: `file`, `symbol`, `timeframe`, `year`, `overwrite` (선택)

4. **유닛 테스트 작성**:
   - 유효한 파일 업로드 성공
   - 잘못된 확장자 거부
   - 필수 컬럼 누락 파일 거부
   - 덮어쓰기 시도 시 409 Conflict
   - `overwrite=true` 시 덮어쓰기 성공
   - 화이트리스트 패턴 위반 또는 경로 이탈(`../`) 시도 거부

**의존성**: Step 1
**산출물**: 완전한 `/api/data/upload` 엔드포인트, 유닛 테스트
**확인 방법**: `pytest tests/test_data_api.py::test_upload_*` 통과

---

#### **Step 4: 프론트엔드 라우팅 설정 (Task 3.3, 1시간)**
**목표**: React Router를 설정하여 `/data` 페이지 추가

**작업 내용**:
1. **기존 구조 리팩토링**:
   - `App.jsx` → `BacktestPage.jsx`로 이름 변경 및 이동
   - `main.jsx`에 React Router 설정 추가

2. **라우터 설정**:
   ```jsx
   <BrowserRouter>
     <Routes>
       <Route path="/" element={<BacktestPage />} />
       <Route path="/data" element={<DataManagementPage />} />
     </Routes>
   </BrowserRouter>
   ```

3. **네비게이션 추가**:
   - 공통 헤더 컴포넌트 생성 (백테스트 / 데이터 관리 탭)

**의존성**: 없음
**산출물**: 수정된 `main.jsx`, `BacktestPage.jsx`, 기본 `DataManagementPage.jsx`
**확인 방법**: 브라우저에서 `/` 및 `/data` 경로 접근 확인

---

#### **Step 5: 데이터 관리 페이지 UI 구현 (Task 3.3, 4~5시간)**
**목표**: 데이터 파일 조회 및 업로드 UI 구현

**작업 내용**:
1. **REST API 래퍼 구현** (`frontend/src/services/dataApi.js`):
   ```javascript
   export async function fetchInventory({ symbol, timeframe, limit, offset }) { ... }
   export async function uploadFile({ file, symbol, timeframe, year, overwrite }) { ... }
   ```

2. **데이터 테이블 컴포넌트**:
   - 컬럼: 심볼, 타임프레임, 연도, 파일 크기, 수정일
   - 필터 UI: 심볼, 타임프레임 Select
   - 페이지네이션 컨트롤

3. **파일 업로드 폼**:
   - 파일 선택 (`.parquet`만 허용)
   - 심볼 입력 (대문자 자동 변환)
   - 타임프레임 Select (`1D`, `1H`, `5M`, `1M`)
   - 연도 입력
   - Overwrite 체크박스
   - 업로드 버튼

4. **상태 관리**:
   - 로딩 스피너
   - 에러 토스트 (업로드 실패, 조회 실패)
   - 업로드 성공 시 인벤토리 재조회

**의존성**: Step 2, Step 3, Step 4
**산출물**: 완전한 `DataManagementPage.jsx`, `dataApi.js`
**확인 방법**: 브라우저에서 UI 동작 테스트 (수동)

---

#### **Step 6: 문서화 (Task 3.4, 1시간)**
**목표**: 데이터 관리 규칙 및 API 스펙 문서 작성

**작업 내용**:
- `docs/coin/mvp/data_management_spec.md` 작성
  - 파일 구조 및 네이밍 규칙
  - 필수 컬럼 및 타임존 처리 규칙
  - API 보안/검증 규칙
  - 확장 계획 (데이터 정합성 검사, 삭제 기능, 통계 API)

**의존성**: Step 2, Step 3
**산출물**: `data_management_spec.md`
**확인 방법**: 문서 검토 및 승인

---

#### **Step 7: E2E 테스트 시나리오 작성 및 검증 (Task 3.5, 2~3시간)**
**목표**: 전체 시스템 통합 테스트

**작업 내용**:
1. **E2E 테스트 스크립트 작성** (`scripts/e2e_test_data_management.py`):
   - ✅ `test_inventory_empty`: 초기 빈 상태 확인
   - ✅ `test_upload_valid_file`: 유효한 파일 업로드 성공
   - ✅ `test_upload_invalid_file`: 잘못된 파일 업로드 실패
   - ✅ `test_upload_traversal_attempt`: 경로 이탈 입력 차단 확인
   - ✅ `test_inventory_after_upload`: 업로드 후 반영 확인
   - ✅ `test_backtest_with_uploaded_data`: 업로드 데이터로 백테스트 실행
   - ✅ `--base-url` 옵션 추가 (로컬/Docker 호환성)
   - ✅ 헬스 체크 함수 구현 (최대 30초 대기, 5회 재시도)
   - ✅ 환경 의존 로직 개선 (localhost 기본값 → 커스텀 URL 지원)

2. **E2E 테스트 실행 스크립트 수정** (`scripts/run_e2e_tests.sh`):
   - ✅ `--with-data-management` 옵션 추가
   - ✅ 옵션 전달 시 `scripts/e2e_test_data_management.py` 직접 실행
   - ✅ Docker Compose 환경에서는 `backend:8000` 서비스 DNS 이름으로 접근
   - ✅ 기존 플로우와 충돌하지 않도록 플래그 기반 조건 처리
   - ✅ 헬퍼 메시지 및 사용법 문서화

3. **로컬/Docker 호환성**:
   - ✅ 로컬 개발 환경: `python scripts/e2e_test_data_management.py`
   - ✅ Docker 환경: `python scripts/e2e_test_data_management.py --base-url http://backend:8000`
   - ✅ 친절한 에러 메시지 및 해결 방법 안내

4. **모든 테스트 통과 확인**:
   - ✅ 유닛 테스트 (`tests/test_data_api.py`)
   - ✅ E2E 테스트 (로컬 및 Docker)
   - ✅ 기존 백테스트 E2E 테스트와의 호환성

**의존성**: Step 2, Step 3, Step 5
**산출물**:
- `e2e_test_data_management.py` (--base-url 옵션 지원)
- `run_e2e_tests.sh` (--with-data-management 옵션 추가)
- `data_management_spec.md` (스펙 문서)

**확인 방법**:
```bash
# 로컬 개발 환경
python scripts/e2e_test_data_management.py

# Docker 환경
./scripts/run_e2e_tests.sh --with-data-management

# 커스텀 URL
python scripts/e2e_test_data_management.py --base-url http://your-server:8000
```

---

## 4. 리스크 및 대응 방안

| 리스크 | 대응 방안 |
|--------|-----------|
| **대용량 디렉토리 스캔 성능 저하** | 페이지네이션 적용 및 기본 정렬(최근 수정일 내림차순) |
| **파일 업로드 동시성 문제** | 현재는 단일 사용자 가정, 문서에 명시 (차후 락 메커니즘 추가) |
| **인증/권한 시스템 부재** | 현재는 인증 없음, 문서에 명시 (차후 관리자 토큰 추가) |
| **파일 업로드 크기 제한** | FastAPI, Nginx, Docker 설정 확인 필요 |

---

## 5. 추가 확인 필요 사항

이 작업을 시작하기 전에 다음 사항에 대한 의사결정이 필요합니다:

1. **데이터 삭제 기능**: 이번 MVP에 포함할지 여부? (이슈에는 명시되지 않음)
2. **데이터 정합성 검사**: 중복 타임스탬프, 누락 구간 검사를 언제 수행할지?
3. **행 수(row_count) 집계**: 실시간 계산은 성능 이슈로 제외했는데, 캐시 또는 별도 오프라인 작업 필요 여부?
4. **인증 방식**: 현재 인증 없이 진행할지, 아니면 기본적인 API 키 인증을 먼저 구현할지?

---

## 6. 예상 작업 시간

| 단계 | 예상 시간 |
|------|-----------|
| Step 1 | 0.5시간 |
| Step 2 | 2~3시간 |
| Step 3 | 3~4시간 |
| Step 4 | 1시간 |
| Step 5 | 4~5시간 |
| Step 6 | 1시간 |
| Step 7 | 2~3시간 |
| **총계** | **14~18시간** |

이슈에 명시된 예상 작업 시간(12~17시간)과 유사합니다.

---

## 7. 진행 상태

- [x] Step 1: 백엔드 API 라우터 구조 설정
- [x] Step 2: 데이터 인벤토리 API 구현
- [x] Step 3: 데이터 업로드 API 구현
- [x] Step 4: 프론트엔드 라우팅 설정
- [x] Step 5: 데이터 관리 페이지 UI 구현
- [x] Step 6: 문서화
- [x] Step 7: E2E 테스트 시나리오 작성 및 검증 (보완계획 반영)

## 8. 보완 계획 - 완료 사항

### E2E 테스트 통합 최적화
- [x] `scripts/run_e2e_tests.sh`에 `--with-data-management` 옵션 추가
- [x] `scripts/e2e_test_data_management.py`에 `--base-url` 옵션 추가
- [x] 헬스 체크 함수 구현 (최대 30초 대기, 5회 재시도)
- [x] 로컬/Docker 호환성 개선
- [x] 친절한 에러 메시지 및 해결 방법 안내
- [x] `docs/coin/mvp/ri_13.md` 업데이트 (Step 7 상세 작업 반영)

### 테스트 실행 방법
```bash
# 로컬 개발 환경 (기본값)
python scripts/e2e_test_data_management.py

# Docker 환경 (통합 E2E 테스트)
./scripts/run_e2e_tests.sh --with-data-management

# 커스텀 URL
python scripts/e2e_test_data_management.py --base-url http://your-server:8000

# 모든 도움말
./scripts/run_e2e_tests.sh --help
python scripts/e2e_test_data_management.py --help
```
