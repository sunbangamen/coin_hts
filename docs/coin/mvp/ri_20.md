# Task 3.5: ê²°ê³¼ ì €ì¥ ê°œì„  - PostgreSQL + Parquet ë§ˆì´ê·¸ë ˆì´ì…˜

**ì´ìŠˆ ë¶„ì„ ë° í•´ê²° ê³„íš ë¬¸ì„œ**

---

## 1. ì´ìŠˆ ì •ë³´ ìˆ˜ì§‘

### ê¸°ë³¸ ë©”íƒ€ë°ì´í„°
- **ì´ìŠˆ ë²ˆí˜¸**: #33
- **ì œëª©**: Task 3.5: ê²°ê³¼ ì €ì¥ ê°œì„  - PostgreSQL + Parquet ë§ˆì´ê·¸ë ˆì´ì…˜
- **ìƒíƒœ**: OPEN
- **URL**: https://github.com/sunbangamen/coin_hts/issues/33
- **ë‹´ë‹¹ì**: ì—†ìŒ
- **ë¼ë²¨**: ì—†ìŒ

### ê´€ë ¨ ì»¨í…ìŠ¤íŠ¸
- **í˜„ì¬ ë¸Œëœì¹˜**: `33`
- **ì°¸ì¡° ë¬¸ì„œ**:
  - `PHASE3_IMPLEMENTATION_STATUS.md` (Task 3.5 ìƒíƒœ ê¸°ë¡)
  - `docs/coin/mvp_phase.md` (Phase 3 ê³„íš)
- **ê´€ë ¨ íŒŒì¼**:
  - `backend/app/result_manager.py` (ResultManager - ì˜ì¡´ì„± ì£¼ì… ì§€ì›)
  - `backend/app/storage/result_storage.py` (ResultStorage ì¸í„°í˜ì´ìŠ¤ - PostgreSQL ë¼ˆëŒ€ ìˆìŒ)
  - `backend/app/database.py` (DatabaseManager - psycopg2 ê¸°ë°˜)
  - `requirements.txt` (ì˜ì¡´ì„± ëª©ë¡ - pyarrow ìˆìŒ, alembic ì—†ìŒ)

---

## 2. ë¬¸ì œ ì´í•´

### í•µì‹¬ ìš”êµ¬ì‚¬í•­
í˜„ì¬ ë°±í…ŒìŠ¤íŠ¸ ê²°ê³¼ê°€ **JSON íŒŒì¼ ê¸°ë°˜**ìœ¼ë¡œ ì €ì¥ë˜ì–´ ë‹¤ìŒ ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤:
1. **ì €ì¥ ê³µê°„ ë‚­ë¹„**: ëŒ€ìš©ëŸ‰ ì‹ í˜¸ ë°ì´í„°ë¥¼ JSONìœ¼ë¡œ ì €ì¥ ì‹œ ë¹„íš¨ìœ¨
2. **ì¡°íšŒ ì„±ëŠ¥ ì €í•˜**: ë©”íƒ€ë°ì´í„° ê²€ìƒ‰ ì‹œ íŒŒì¼ ì‹œìŠ¤í…œ ì˜ì¡´
3. **í™•ì¥ì„± ì œí•œ**: í•„í„°ë§, í˜ì´ì§€ë„¤ì´ì…˜, í†µê³„ ê³„ì‚° ë“±ì´ ë¹„íš¨ìœ¨ì 

### ëª©í‘œ
**PostgreSQL (ë©”íƒ€ë°ì´í„°) + Parquet (ëŒ€ìš©ëŸ‰ ë°ì´í„°)** ì¡°í•©ìœ¼ë¡œ ì „í™˜í•˜ì—¬:
- ğŸ“Š **ì €ì¥ ê³µê°„ ì••ì¶•** (ëª©í‘œ: â‰¥95% ê°ì†Œ, ì‹¤ì œ ì¸¡ì • í•„ìš”)
- ğŸ” **ë¹ ë¥¸ ë©”íƒ€ë°ì´í„° ê²€ìƒ‰** (task_id, strategy, ë‚ ì§œ, ìƒíƒœ ê¸°ë°˜)
- ğŸ“¦ **íš¨ìœ¨ì ì¸ ëŒ€ìš©ëŸ‰ ë°ì´í„° ì••ì¶•** (Parquet Snappy)

### í˜„ì¬ ìƒíƒœ
- `PostgreSQLResultStorage` í´ë˜ìŠ¤: ì¸í„°í˜ì´ìŠ¤ë§Œ ì •ì˜, êµ¬í˜„ ë¯¸ì™„ë£Œ
- `ResultManager`: ì˜ì¡´ì„± ì£¼ì… ì§€ì› ì™„ë£Œ (storage íŒŒë¼ë¯¸í„°)
- `alembic`: `requirements.txt`ì— ì—†ìŒ (ë§ˆì´ê·¸ë ˆì´ì…˜ ë„êµ¬ í•„ìš”)
- JSON ì €ì¥ ê²½ë¡œ: `data/tasks/{task_id}/result.json`

### ê¸°ìˆ  ìŠ¤íƒ
- PostgreSQL (ë©”íƒ€ë°ì´í„°)
- Parquet + pyarrow (ëŒ€ìš©ëŸ‰ ì••ì¶•)
- Alembic (ìŠ¤í‚¤ë§ˆ ë²„ì „ ê´€ë¦¬)
- SQLAlchemy (ORM - í˜„ì¬ ë¯¸ì‚¬ìš©, psycopg2ë§Œ ì‚¬ìš©)

---

## 3. í•´ê²° ê³„íš ìˆ˜ë¦½

### ì „ì²´ êµ¬ì¡°
```
Task 3.5 = 6ê°œ ì„œë¸ŒíƒœìŠ¤í¬ (3.5.1 ~ 3.5.6)
â”œâ”€ 3.5.1: PostgreSQL ìŠ¤í‚¤ë§ˆ ì„¤ê³„ (DDL + ERD)
â”œâ”€ 3.5.2: Alembic ë§ˆì´ê·¸ë ˆì´ì…˜ ì¸í”„ë¼
â”œâ”€ 3.5.3: PostgreSQLResultStorage ì™„ì „ êµ¬í˜„
â”œâ”€ 3.5.4: JSON â†’ Parquet ë³€í™˜ ìœ í‹¸ë¦¬í‹°
â”œâ”€ 3.5.5: ê¸°ì¡´ JSON ê²°ê³¼ ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸
â””â”€ 3.5.6: ì„±ëŠ¥ ê²€ì¦ ë° í†µí•© í…ŒìŠ¤íŠ¸
```

### ë‹¨ê³„ë³„ ìƒì„¸ ê³„íš

#### **Phase 1: ì„¤ê³„ ë° ê¸°ì´ˆ ì¸í”„ë¼ (ìš°ì„ ìˆœìœ„ 1-2)**

##### Task 3.5.1: PostgreSQL ìŠ¤í‚¤ë§ˆ ì„¤ê³„ (3-4ì‹œê°„)
**ì‘ì—… ë‚´ìš©**:
1. `backtest_results` í…Œì´ë¸” DDL ì‘ì„±
   - ì»¬ëŸ¼: task_id (UUID PK), strategy, symbols (JSONB), start_date, end_date, status, created_at, updated_at, parquet_path, file_size, record_count, metadata
   - ì¸ë±ìŠ¤: task_id, created_at, strategy, status, symbols (GIN)
   - ì œì•½ì¡°ê±´: UNIQUE(task_id), CHECK(status IN ('completed', 'failed', 'running'))
   - íŠ¸ë¦¬ê±°: updated_at ìë™ ê°±ì‹ 

2. Parquet ìŠ¤í‚¤ë§ˆ ì •ì˜
   - `symbol_summary`: symbol, win_rate, avg_return, max_drawdown, avg_hold_bars, total_signals
   - `symbol_signals`: symbol, signal_index, timestamp, type, entry_price, exit_price, return_pct
   - `performance_curve`: symbol, idx, timestamp, equity, drawdown

3. ERD ì‘ì„± ë° ë¬¸ì„œí™”
   - íŒŒì¼: `docs/coin/mvp/RESULT_STORAGE_SCHEMA.md` ìƒì„±

**ì‚°ì¶œë¬¼**:
- `docs/coin/mvp/RESULT_STORAGE_SCHEMA.md`
- DDL SQL íŒŒì¼ (ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ì— í¬í•¨ ì˜ˆì •)

**ì˜ì¡´ì„±**: ì—†ìŒ

**í™•ì¸ ë°©ë²•**: ìŠ¤í‚¤ë§ˆ ë¬¸ì„œ ê²€í† , DDL ìœ íš¨ì„± í™•ì¸

---

##### Task 3.5.2: Alembic ë§ˆì´ê·¸ë ˆì´ì…˜ ì¸í”„ë¼ (2-3ì‹œê°„)
**ì‘ì—… ë‚´ìš©**:
1. `requirements.txt`ì— `alembic` ì¶”ê°€
2. Alembic ì´ˆê¸°í™”: `alembic init alembic`
3. `alembic.ini` ì„¤ì •
   - `sqlalchemy.url` â†’ í™˜ê²½ ë³€ìˆ˜ `DATABASE_URL` ì‚¬ìš©
4. `alembic/env.py` ìˆ˜ì •
   - ê¸°ì¡´ `backend/app/database.py` ì—°ë™
   - psycopg2 ê¸°ë°˜ ì—°ê²° ì‚¬ìš©
   - SQLAlchemy `MetaData`ë¥¼ `backend/app/models/backtest_result.py`ì—ì„œ ê°€ì ¸ì™€ ë“±ë¡
5. SQLAlchemy ORM/í…Œì´ë¸” ì •ì˜ ì¶”ê°€
   - íŒŒì¼: `backend/app/models/backtest_result.py`
   - Alembic autogenerateê°€ ì •ìƒ ì‘ë™í•˜ë„ë¡ `Base.metadata` ë…¸ì¶œ
   - ORMì´ ë¶ˆí•„ìš”í•  ê²½ìš° ìˆ˜ë™ DDL ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë²„ì „ íŒŒì¼ì— ì§ì ‘ ì‘ì„±
6. ì´ˆê¸° ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
   - ORM/MetaDataë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°: `alembic revision --autogenerate -m "Create backtest_results table"`
   - ìˆ˜ë™ ê´€ë¦¬ ì„ íƒ ì‹œ: `alembic revision -m "Create backtest_results table"` í›„ DDLì„ ì§ì ‘ ì‘ì„±
7. ë§ˆì´ê·¸ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸
   - `alembic upgrade head`
   - `alembic downgrade -1`

**ì‚°ì¶œë¬¼**:
- `requirements.txt` (alembic ì¶”ê°€)
- `alembic/` ë””ë ‰í† ë¦¬ (env.py, versions/)
- `alembic.ini` ì„¤ì • íŒŒì¼
- `backend/app/models/backtest_result.py` (ì„ íƒ)

**ì˜ì¡´ì„±**: Task 3.5.1 (DDL ì •ì˜ í•„ìš”)

**í™•ì¸ ë°©ë²•**: ë¡œì»¬ PostgreSQLì—ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ ì„±ê³µ

---

#### **Phase 2: ë³€í™˜ ë° ì €ì¥ì†Œ êµ¬í˜„ (ìš°ì„ ìˆœìœ„ 3-4)**

##### Task 3.5.4: JSON â†’ Parquet ë³€í™˜ ìœ í‹¸ë¦¬í‹° (4-5ì‹œê°„)
**ì‘ì—… ë‚´ìš©**:
1. `backend/app/storage/converters.py` ìƒì„±
2. `json_to_parquet()` í•¨ìˆ˜ êµ¬í˜„
   - ì…ë ¥: BacktestResult dict (JSON í˜•ì‹)
   - ì¶œë ¥: 3ê°œ Parquet í…Œì´ë¸” (symbol_summary, symbol_signals, performance_curve)
   - Snappy ì••ì¶• ì ìš©
   - ìŠ¤í‚¤ë§ˆ ê²€ì¦ (pyarrow.schema)
3. `parquet_to_json()` ì—­ë³€í™˜ í•¨ìˆ˜ (ì„ íƒì‚¬í•­)
4. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„±
   - `tests/test_converters.py`
   - ìƒ˜í”Œ JSON â†’ Parquet ë³€í™˜
   - Parquet ì½ê¸° ë° ë°ì´í„° ê²€ì¦
   - ì••ì¶•ë¥  í™•ì¸ (ëª©í‘œ: â‰¥95%)

**ì‚°ì¶œë¬¼**:
- `backend/app/storage/converters.py`
- `tests/test_converters.py`

**ì˜ì¡´ì„±**: Task 3.5.1 (Parquet ìŠ¤í‚¤ë§ˆ ì •ì˜ í•„ìš”)

**í™•ì¸ ë°©ë²•**: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ í†µê³¼, ì••ì¶•ë¥  â‰¥95%

---

##### Task 3.5.3: PostgreSQLResultStorage ì™„ì „ êµ¬í˜„ (6-8ì‹œê°„)
**ì‘ì—… ë‚´ìš©**:
1. `backend/app/storage/result_storage.py` ìˆ˜ì •
2. `PostgreSQLResultStorage.__init__()` ê°œì„ 
   - SQLAlchemy ì—”ì§„ ë˜ëŠ” DatabaseManager ì‚¬ìš©
   - ì—°ê²° í’€ ê´€ë¦¬
3. `save_result()` êµ¬í˜„
   - ë©”íƒ€ë°ì´í„° PostgreSQL INSERT (íŠ¸ëœì­ì…˜)
   - Parquet íŒŒì¼ ì €ì¥ (Dataset ë£¨íŠ¸: `backtests/{task_id}/`)
     - `symbol_summary.parquet`, `symbol_signals.parquet`, `performance_curve.parquet`
     - ë™ì¼ ë””ë ‰í„°ë¦¬ì— `metadata.json` ì €ì¥í•˜ì—¬ ìŠ¤í‚¤ë§ˆ ë²„ì „ ê¸°ë¡
   - converters.json_to_parquet() í˜¸ì¶œ
   - ì‹¤íŒ¨ ì‹œ ë¡¤ë°± ë° ë¡œê¹…
4. `get_result()` êµ¬í˜„
   - task_idë¡œ PostgreSQL SELECT
   - Parquet íŒŒì¼ ì½ê¸° (pyarrow.parquet.read_table)
   - ë©”íƒ€ë°ì´í„° + ê²°ê³¼ ë°ì´í„° ë³‘í•©
5. `cleanup_old_results()` êµ¬í˜„
   - `created_at < NOW() - N days` ì¡°ê±´ ì¡°íšŒ
   - Parquet íŒŒì¼ ì‚­ì œ
   - PostgreSQL DELETE
   - dry_run ëª¨ë“œ ì§€ì›
6. `list_results()` êµ¬í˜„
   - ORDER BY created_at DESC LIMIT N
   - í•„í„°ë§ (strategy, status, symbols)
   - í˜ì´ì§€ë„¤ì´ì…˜ (offset, limit)
7. ì—ëŸ¬ í•¸ë“¤ë§ ë° ë¡œê¹…
8. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„±
   - `tests/test_postgresql_result_storage.py`

**ì‚°ì¶œë¬¼**:
- `backend/app/storage/result_storage.py` (PostgreSQLResultStorage êµ¬í˜„ ì™„ë£Œ)
- `tests/test_postgresql_result_storage.py`

**ì˜ì¡´ì„±**: Task 3.5.2 (DB ìŠ¤í‚¤ë§ˆ), Task 3.5.4 (ë³€í™˜ ìœ í‹¸ë¦¬í‹°)

**í™•ì¸ ë°©ë²•**: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ í†µê³¼, CRUD ë™ì‘ ê²€ì¦

---

#### **Phase 3: ë§ˆì´ê·¸ë ˆì´ì…˜ ë° ê²€ì¦ (ìš°ì„ ìˆœìœ„ 5-6)**

##### Task 3.5.5: ê¸°ì¡´ JSON ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ (3-4ì‹œê°„)
**ì‘ì—… ë‚´ìš©**:
1. `scripts/migrate_json_to_parquet.py` ìƒì„±
2. CLI ì˜µì…˜ êµ¬í˜„
   - `--source-dir`: JSON ê²°ê³¼ ë””ë ‰í† ë¦¬ (ê¸°ë³¸: `data/tasks`)
   - `--dry-run`: ëŒ€ìƒ íŒŒì¼ë§Œ ì¶œë ¥
   - `--batch-size`: ë°°ì¹˜ í¬ê¸° (ê¸°ë³¸: 100)
   - `--force`: ê¸°ì¡´ ë ˆì½”ë“œ ë®ì–´ì“°ê¸°
3. ë§ˆì´ê·¸ë ˆì´ì…˜ ë¡œì§
   - `data/tasks` ìˆœíšŒ
   - `result.json` ì½ê¸°
   - converters.json_to_parquet() í˜¸ì¶œ
   - PostgreSQLResultStorage.save_result() í˜¸ì¶œ
   - ì„±ê³µ ì‹œ JSON íŒŒì¼ì„ `backups/` ì´ë™
   - ë§ˆì´ê·¸ë ˆì´ì…˜ ê¸°ê°„ ë™ì•ˆ ResultManagerê°€ JSONê³¼ Parquet ëª¨ë‘ì— ì´ì¤‘ ì €ì¥í•˜ë„ë¡ feature flag ë„ì…
   - ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹œ ìƒì„±ì¼ ê¸°ì¤€ ì»¤íŠ¸ë¼ì¸ì„ ë°›ì•„ ì´ì¤‘ ì €ì¥ ì´ì „/ì´í›„ ë°ì´í„° êµ¬ê°„ì„ ëª…í™•íˆ ì²˜ë¦¬
4. ì§„í–‰ ìƒí™© í‘œì‹œ (tqdm)
5. ì—ëŸ¬ í•¸ë“¤ë§ (ì‹¤íŒ¨ íŒŒì¼ ë¡œê·¸)
6. ë§ˆì´ê·¸ë ˆì´ì…˜ ë³´ê³ ì„œ ìƒì„±
   - ì´ íŒŒì¼ ìˆ˜, ì„±ê³µ/ì‹¤íŒ¨ ê°œìˆ˜
   - ì••ì¶•ë¥  (%), ì†Œìš” ì‹œê°„
7. ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸ ì‘ì„± (ì„ íƒì‚¬í•­)
   - `scripts/rollback_parquet_to_json.py`

**ì‚°ì¶œë¬¼**:
- `scripts/migrate_json_to_parquet.py`
- `scripts/rollback_parquet_to_json.py` (ì„ íƒ)
- ë§ˆì´ê·¸ë ˆì´ì…˜ ë³´ê³ ì„œ (stdout)

**ì˜ì¡´ì„±**: Task 3.5.3, Task 3.5.4

**í™•ì¸ ë°©ë²•**: í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì„±ê³µë¥  â‰¥95%

---

##### Task 3.5.6: ì„±ëŠ¥ ê²€ì¦ ë° í†µí•© í…ŒìŠ¤íŠ¸ (2-3ì‹œê°„)
**ì‘ì—… ë‚´ìš©**:
1. `scripts/benchmark_result_storage.py` ìƒì„±
   - 10,000ê°œ ì‹ í˜¸ ë°±í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìƒì„±
   - JSON vs Parquet íŒŒì¼ í¬ê¸° ë¹„êµ
   - ì••ì¶•ë¥  ê³„ì‚° (ëª©í‘œ: â‰¥95%)
   - ì¡°íšŒ ì„±ëŠ¥ ë¹„êµ
2. `tests/integration/test_result_storage_migration.py` ìƒì„±
   - ì‹œë‚˜ë¦¬ì˜¤ 1: ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰ â†’ PostgreSQL + Parquet ì €ì¥ â†’ ì¡°íšŒ
   - ì‹œë‚˜ë¦¬ì˜¤ 2: JSON ë§ˆì´ê·¸ë ˆì´ì…˜ â†’ ìƒˆ í¬ë§· ì¡°íšŒ
   - ì‹œë‚˜ë¦¬ì˜¤ 3: Nì¼ ì´ìƒëœ ê²°ê³¼ ì •ë¦¬
3. íšŒê·€ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
   - `pytest tests/` â†’ 299ê°œ í…ŒìŠ¤íŠ¸ (2025-11-11 ê¸°ì¤€, scripts/count_tests.py ì°¸ì¡°)
4. ì„±ëŠ¥ ë³´ê³ ì„œ ì‘ì„±
   - `docs/coin/mvp/RESULT_STORAGE_PERFORMANCE.md`
   - JSON vs Parquet ë¹„êµí‘œ
   - ê²°ë¡  ë° ê¶Œì¥ì‚¬í•­

**ì‚°ì¶œë¬¼**:
- `scripts/benchmark_result_storage.py`
- `tests/integration/test_result_storage_migration.py`
- `docs/coin/mvp/RESULT_STORAGE_PERFORMANCE.md`

**ì˜ì¡´ì„±**: Task 3.5.3, Task 3.5.4, Task 3.5.5

**í™•ì¸ ë°©ë²•**: ì„±ëŠ¥ ëª©í‘œ ë‹¬ì„±, í†µí•© í…ŒìŠ¤íŠ¸ í†µê³¼

---

### ìœ„í—˜ ìš”ì†Œ ë° ì˜¤í”ˆ ì§ˆë¬¸

#### 1. ë™ì‹œì„± ì œì–´
**ì§ˆë¬¸**: ì—¬ëŸ¬ RQ ì›Œì»¤ê°€ ë™ì‹œì— ê°™ì€ task_idì— ê²°ê³¼ë¥¼ ì €ì¥í•˜ë ¤ í•  ë•Œ ì¶©ëŒ ë°©ì§€ê°€ í•„ìš”í•œê°€ìš”?

**í˜„ì¬ íŒë‹¨**: PostgreSQL UNIQUE ì œì•½ì¡°ê±´(task_id)ìœ¼ë¡œ ì¶©ë¶„. task_idê°€ UUIDì´ë¯€ë¡œ ì¶©ëŒ ê°€ëŠ¥ì„± ë‚®ìŒ.

**ê¶Œì¥**: ì´ˆê¸° êµ¬í˜„ì€ UNIQUE ì œì•½ì¡°ê±´ë§Œ ì‚¬ìš©, ë¬¸ì œ ë°œìƒ ì‹œ Redis Lock ì¶”ê°€

---

#### 2. Parquet ìŠ¤í‚¤ë§ˆ ë²„ì „ ê´€ë¦¬
**ì§ˆë¬¸**: Parquet ìŠ¤í‚¤ë§ˆ ë³€ê²½ ì‹œ (ì˜ˆ: ìƒˆ ì»¬ëŸ¼ ì¶”ê°€) ê¸°ì¡´ íŒŒì¼ê³¼ í˜¸í™˜ì„±ì€ ì–´ë–»ê²Œ ë³´ì¥í•˜ë‚˜ìš”?

**í˜„ì¬ íŒë‹¨**: Parquet ë©”íƒ€ë°ì´í„°ì— ìŠ¤í‚¤ë§ˆ ë²„ì „ ê¸°ë¡, ì½ê¸° ì‹œ ë²„ì „ë³„ ì²˜ë¦¬

**ê¶Œì¥**:
- Phase 1: ê³ ì • ìŠ¤í‚¤ë§ˆ ì‚¬ìš© (ë²„ì „ 1.0)
- Phase 2: ë²„ì „ í•„ë“œ ì¶”ê°€, ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ì¤€ë¹„

---

#### 3. ëŒ€ìš©ëŸ‰ ë°ì´í„° ì²˜ë¦¬
**ì§ˆë¬¸**: 100,000ê°œ ì´ìƒ ì‹ í˜¸ ì²˜ë¦¬ ì‹œ ë©”ëª¨ë¦¬ ë¬¸ì œ ë°œìƒ ê°€ëŠ¥ì„±ì€?

**í˜„ì¬ íŒë‹¨**: Parquet Row Group í¬ê¸° ì¡°ì • (ê¸°ë³¸: 1,000 rows â†’ 10,000 rows)

**ê¶Œì¥**:
- ì´ˆê¸° êµ¬í˜„: ê¸°ë³¸ ì„¤ì • ì‚¬ìš©
- ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ í›„ ì¡°ì •

---

#### 4. ë°±ì—… ì „ëµ
**ì§ˆë¬¸**: Parquet íŒŒì¼ì„ S3ì— ìë™ ë°±ì—…í•˜ëŠ” ë¡œì§ì´ í•„ìš”í•œê°€ìš”?

**í˜„ì¬ íŒë‹¨**: Task 3.4 (S3 ìŠ¤í† ë¦¬ì§€)ì™€ ë¶„ë¦¬, Task 3.7 (ë°±ì—…/ëª¨ë‹ˆí„°ë§)ì—ì„œ ì²˜ë¦¬

**ê¶Œì¥**: Task 3.5ì—ì„œëŠ” ë¡œì»¬ Parquet ì €ì¥ë§Œ êµ¬í˜„

---

#### 5. Parquet ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„ íƒ
**ì„ íƒ**: `pyarrow` (ì´ë¯¸ requirements.txtì— ì¡´ì¬)

**ì´ìœ **: Apache Arrow ìƒíƒœê³„, ë¹ ë¥¸ ì„±ëŠ¥, í™œë°œí•œ ì»¤ë®¤ë‹ˆí‹°

---

#### 6. ë§ˆì´ê·¸ë ˆì´ì…˜ ë‹¤ìš´íƒ€ì„
**ì§ˆë¬¸**: ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘ ì„œë¹„ìŠ¤ ì¤‘ë‹¨ì´ í•„ìš”í•œê°€ìš”?

**ê¶Œì¥**: Zero-downtime Blue-Green ì „ëµ
- ì• í”Œë¦¬ì¼€ì´ì…˜ ì¸¡ì—ì„œ feature flag(`RESULT_STORAGE_MODE`)ë¡œ JSON-only, Dual-write, Postgres/Parquet-only 3ë‹¨ê³„ë¥¼ ì „í™˜
- Dual-write ë‹¨ê³„ì—ì„œ ResultManagerê°€ `PostgreSQLResultStorage`ì™€ ê¸°ì¡´ JSON íŒŒì¼ ëª¨ë‘ì— ê²°ê³¼ë¥¼ ê¸°ë¡í•˜ì—¬ ë°ì´í„° ìœ ì‹¤ ë°©ì§€
- `scripts/migrate_json_to_parquet.py`ëŠ” Dual-write ì‹œì‘ ì´ì „ ìƒì„±ëœ ë°ì´í„°ë¥¼ ëŒ€ìƒìœ¼ë¡œ ëŒë¦¬ê³ , ì‘ì—… ì™„ë£Œ í›„ flagë¥¼ Postgres/Parquet-onlyë¡œ ì „í™˜
- JSON ë°±ì—…ì€ Dual-write ì¢…ë£Œ ì‹œì ê¹Œì§€ ìœ ì§€, ì´í›„ ì¼ì • ê¸°ê°„ ë™ì•ˆ ì½ê¸° ì „ìš© ëª¨ë“œë¡œ ë³´ê´€

---

### ì˜ˆìƒ ì‹œê°„
- Task 3.5.1: 3-4ì‹œê°„
- Task 3.5.2: 2-3ì‹œê°„
- Task 3.5.3: 6-8ì‹œê°„
- Task 3.5.4: 4-5ì‹œê°„
- Task 3.5.5: 3-4ì‹œê°„
- Task 3.5.6: 2-3ì‹œê°„
- **ì´í•©**: 20-27ì‹œê°„ (ì•½ 3-4ì¼)

---

### ì„±ê³µ ê¸°ì¤€
- ğŸ“Š **ì••ì¶•ë¥ **: JSON ëŒ€ë¹„ â‰¥95% ì €ì¥ ê³µê°„ ê°ì†Œ (ëª©í‘œ, ì‹¤ì œ ì¸¡ì • í•„ìš”)
- ğŸ” **ì¡°íšŒ ì„±ëŠ¥**: Parquetì´ JSON ëŒ€ë¹„ ë™ë“± ì´ìƒ (ì‹¤ì œ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ í•„ìš”)
- âœ… **ë§ˆì´ê·¸ë ˆì´ì…˜ ì„±ê³µë¥ **: â‰¥95% (--dry-runìœ¼ë¡œ ì‚¬ì „ ê²€ì¦)
- âœ… **í…ŒìŠ¤íŠ¸ í†µê³¼**: 299ê°œ êµ¬í˜„ëœ í…ŒìŠ¤íŠ¸ ëª¨ë‘ í†µê³¼ (2025-11-11 ê¸°ì¤€, scripts/count_tests.py ì°¸ì¡°)
- ğŸ”„ **ë¡¤ë°± ê°€ëŠ¥**: ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ JSON ë°±ì—… ìœ ì§€

---

## 4. êµ¬í˜„ í˜„í™© ë° ë‹¤ìŒ ë‹¨ê³„

### í˜„ì¬ ìƒíƒœ (ì‹¤ì œ êµ¬í˜„)

**âœ… êµ¬í˜„ ì™„ë£Œ:**
- Task 3.5.1: PostgreSQL ìŠ¤í‚¤ë§ˆ ì„¤ê³„ âœ…
- Task 3.5.2: Alembic ë§ˆì´ê·¸ë ˆì´ì…˜ ì¸í”„ë¼ âœ…
- Task 3.5.4: JSON â†’ Parquet ë³€í™˜ ìœ í‹¸ë¦¬í‹° âœ…
- Task 3.5.3: PostgreSQLResultStorage ì™„ì „ êµ¬í˜„ âœ…
- Task 3.5.5: ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ (ë°°ì¹˜/ê°•ì œ ì˜µì…˜ ì¶”ê°€) âœ…
- Task 3.5.6: ì„±ëŠ¥ ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ë° í†µí•© í…ŒìŠ¤íŠ¸ âœ…

**í…ŒìŠ¤íŠ¸ ì‹¤ì œ ê°œìˆ˜ (2025-11-11, `scripts/count_tests.py` ê¸°ì¤€):**
- ì „ì²´: 299ê°œ (ë‹¨ìœ„ 267ê°œ, í†µí•© 32ê°œ)
- Task 3.5 ê´€ë ¨: 68ê°œ
  - test_converters.py: 11ê°œ
  - test_postgresql_result_storage.py: 13ê°œ
  - tests/integration/test_result_storage_migration.py: 11ê°œ
  - test_migration_batch_force.py: 7ê°œ
  - test_migration_script_e2e.py: 15ê°œ
  - test_dual_write_integration.py: 11ê°œ

**Dual-write ê¸°ëŠ¥ (êµ¬í˜„ ì§„í–‰ ì¤‘):**

| í•­ëª© | ìƒíƒœ | ë¹„ê³  |
|------|------|------|
| RESULT_STORAGE_MODE í™˜ê²½ë³€ìˆ˜ | âœ… êµ¬í˜„ | 3ê°œ ëª¨ë“œ ì§€ì› |
| ResultManager ì €ì¥ì†Œ ëª¨ë“œ ì„ íƒ | âœ… êµ¬í˜„ | í™˜ê²½ë³€ìˆ˜ì— ë”°ë¼ ê²°ì • |
| save_manifest_file() dual-write | ğŸ”„ ë³´ì™„ í•„ìš” | ì‹¤ì œ ë°±í…ŒìŠ¤íŠ¸ ë°ì´í„° ì „ë‹¬ êµ¬ì¡° ê°œì„  |
| ì—ëŸ¬ ì²˜ë¦¬/ë¡¤ë°± ë¡œì§ | ğŸ”„ ë³´ì™„ í•„ìš” | postgres-only ëª¨ë“œ ì‹¤íŒ¨ ì¬ìƒìŠ¹ |

**ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ê¸°ëŠ¥:**

| ê¸°ëŠ¥ | ìƒíƒœ | ë¹„ê³  |
|------|------|------|
| ë°°ì¹˜ ì²˜ë¦¬ (--batch-size) | âœ… êµ¬í˜„ | ì§€ì • í¬ê¸°ë³„ ë°°ì¹˜ ì²˜ë¦¬ |
| ê°•ì œ ì˜µì…˜ (--force) | âœ… êµ¬í˜„ | ê¸°ì¡´ ë ˆì½”ë“œ í™•ì¸ í›„ ë®ì–´ì“°ê¸° |
| ì¤‘ë³µ í™•ì¸/ìŠ¤í‚µ | âœ… êµ¬í˜„ | get_result()ë¡œ í™•ì¸ |
| Force ëª¨ë“œ ì •ì±… | ğŸ”„ ë³´ì™„ í•„ìš” | JSON ë°±ì—…/ì‚­ì œ ì •ì±… ë¬¸ì„œí™” |

### ë‚¨ì€ ì‘ì—…

1. **í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ê²€ì¦** (ì¶”ê°€ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‘ì„±)
2. **ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ ì‹¤ì œ ì‹¤í–‰**
3. **Blue-Green ë°°í¬ ë¬¸ì„œ ìƒì„¸í™”**
4. **ìš´ì˜ ê°€ì´ë“œ ì‘ì„±**

### ì£¼ì˜ì‚¬í•­

- í˜„ì¬ ì½”ë“œëŠ” psycopg2ë§Œ ì‚¬ìš© (SQLAlchemy ë¯¸ë„ì…)
- ì„±ëŠ¥ ëª©í‘œ (â‰¥95% ì••ì¶•ë¥ )ëŠ” ì‹¤ì œ ë²¤ì¹˜ë§ˆí¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ìœ¼ë¡œ ì¸¡ì • í•„ìš”
- í…ŒìŠ¤íŠ¸ëŠ” mockì„ ì‚¬ìš©í•œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (ì‹¤ì œ DB í†µí•© í…ŒìŠ¤íŠ¸ëŠ” @pytest.mark.skip)
- ëª¨ë“  299ê°œ í…ŒìŠ¤íŠ¸ëŠ” êµ¬í˜„ ì™„ë£Œë¨ (Task 3.5: 68ê°œ, 2025-11-11 ê¸°ì¤€, scripts/count_tests.py ì°¸ì¡°)
